{% extends "base.html" %}
{% block main %}


<style media="screen">
   /* Add padding to display Product and Metro region checklist options   */
   .pad {padding:10px;}

   /*Hide the header of display table and no data exception while opening the page*/
   .disptable{display:none;}
   .nodata{display:none;}

</style>


 <div class="container">
    <br>
 </div>
 <div id="fueldata"></div>


 <script type="text/javascript">

    var fuelwatch_data = [];
    // var pos = {};

    // console.log('position',pos);

    //Function to return values for multi check box
    function getvalues(name){
      //Product val and Metro region values for multi check box
      productval = [ {value:"1",id:"Unleaded Petrol"},
                     {value:"2",id:"Premium Unleaded"},
                     {value:"4",id:"Diesel"},
                     {value:"5",id:"LPG"},
                     {value:"6",id:"98 RON"},
                     {value:"7",id:"B20 diesel"},
                     {value:"8",id:"E10"},
                     {value:"9",id:"P100"},
                     {value:"10",id:"E85"},
                   ];

      regionval =[ {value:"25",id:"North of River"},
                   {value:"26",id:"South of River"},
                   {value:"27",id:"East/Hills"},
                 ];

        console.log('3')
      // generated by mithril component by iterating thru array using map method
      if (name == "product"){
        return productval.map(function({value,id}){
          return m('td.pad',m("input",{type :"radio",
                                       name :"Product",
                                       value,
                                       id}
                                    ),id)
        })
      } else if (name == "region"){
        return regionval.map(function({value,id}){
          return m('td.pad',m("input",{type :"checkbox",
                                       name :"Region",
                                       value,
                                       id}
                                    ),id)
        })
      }
    }

    function slider(state){
      // non ui slider which will be created with default values at Mithril "oncreate" node event
      return m("div",{ id:"id_myslider",
        oncreate: function(vnode){
          // This is the same as doing ’document.getElementById(‘id_slider’) to get the element by id and change it;
          var myslider = vnode.dom;
          //slider will be created with default parameters
          noUiSlider.create(myslider,{
                     start: [130, 150],
                     connect: [true, true, true],
                     tooltips: [ true, true ],
                     range: { 'min': 119,'max': 190}
          });
            console.log('4')
          myslider.noUiSlider.on('slide',function(value){
          // Assign slider values to the state variables we use to track the price range to filter on
            state.slider_lowval = value[0];
            state.slider_highval = value[1];
              // console.log('4-2',state.slider_lowval,state.slider_highval);
          // Now that the state variables have been updated, get mithril to redraw the component
          m.redraw();
          });
        },
      }) //slider
    }

    function disptable(dispdata){
      console.log('5','data in disp table',dispdata);
      return m("table.table.table-striped",
              m("thead.thead-dark.disptable",
                // { onupdate: () => console.log("update thead") },
                m("tr",
                  m("th","Price"),
                  m("th","Location"),
                  m("th","Address"),
                  m("th","Phone"),
                  m("th","Brand"),
                  m("th", "Date"),
                  m("th", "Distance"),
                )
              ),
              m("tbody",dispdata.map(i=> m("tr",
                  m("td",  i.Price),
                  m("td",  i.Location),
                  m("td",  i.Address),
                  m("td",  i.Phone),
                  m("td",  i.Brand),
                  m("td",  i.Date),
                  m("td",  i.Distance),)
                )
              )
            )//table
    }

    // function to get user location
    function get_your_location(vnode){
      navigator.geolocation.getCurrentPosition(function(position)
      {
          vnode.state.pos_lat = position.coords.latitude;
          vnode.state.pos_lng = position.coords.longitude;

           user_latlng = (vnode.state.pos_lat,vnode.state.pos_lng);




          console.log('get_your_location',vnode.state.pos_lat,vnode.state.pos_lng);
      })
    }


    // A Mithril component (fuleappdata) is an Object with a view function.
    var fuleappdata = {
      oninit: function(vnode){
        // Assign default variables to slider var on Intialization of Mithril component
        console.log('1')
        vnode.state.slider_lowval = 124;
        vnode.state.slider_highval = 175;
        vnode.state.pos_lat = 0;
        vnode.state.pos_lng = 0;
      },
      view:function(vnode){
        //return filtered data of id_slider between slider value range
        var data = fuelwatch_data.filter(function(item){
          console.log('2',vnode.state.slider_lowval,vnode.state.slider_highval);
          return (item.Price >= vnode.state.slider_lowval && item.Price <= vnode.state.slider_highval);
        });

        // Render HTML for Search functionality
        return m("main",
               m("div",{class:"container-fluid"},),
               m("h4[style=color:#1f2328]",{ class: "text-muted"},"Search Fuel Price"),
               m('div.form-group.col-sm-40 col-form-label',
                m("form",{id:"myform"},
                m("div",
                m("table.table-lg",
                  m('tr', // Multi check box for Product
                      m('td.pad', {label :'Product',style:'font-weight: bold',},"Product"),
                      getvalues('product')
                  ),
                  m('tr', // Multi check box Metro  value
                      m('td.pad', {label :'Metroregion',style:'font-weight: bold',},"Metro Region"),
                      getvalues('region')
                  ),
                  m('tr',
                      m('td.pad', {label :'Tommorrow',class:"form-check-label",style:'font-weight: bold',},"Tomorrow"),
                      m('td.pad',m("input",{type:"checkbox", name:"Tomorrow", class:"form-check-input",id:"Tommorrow",})),
                  ),
                ),
                ),
                m("div",
                m("button", {
                            type:"submit",
                            class:"btn btn-primary",
                            onclick: function(e){
                                    //preventDefault to prevent browser to use/redirect new url
                                    e.preventDefault();
                                    searchdata(vnode)
                                    },
                            },
                  "Submit"),
                ),
              )//myform
            ),//form division
            m("div",
              slider(vnode.state),
            ),
            m("div",
              disptable(data),
            ),
            m("div",
              m("h4.nodata[style=color:#1f2328]",{ class: "text-muted"},"** No Data Found, Please search with different values **"),
            ),
        )// main
      },//mitrril view function
    };//Mithril Component (fuleappdata)


    function searchdata(vnode){

        // get_your_location(vnode);

        navigator.geolocation.getCurrentPosition(function(position)
        {
            vnode.state.pos_lat = position.coords.latitude;
            vnode.state.pos_lng = position.coords.longitude;

             // user_latlng = (vnode.state.pos_lat,vnode.state.pos_lng);

             console.log('searchdata_position',);
             // url will be generated with the parameters
             var url = '{% url 'mithrildata' %}' + '?' + $("#myform").serialize()+'&lat='+vnode.state.pos_lat+'&lng='+vnode.state.pos_lng;
             console.log('7',url);

             //get will pass the request to views.py
             $.get(url,function(json){
                  fuelwatch_data = json;
                  console.log('fd',fuelwatch_data)

                  var price= fuelwatch_data.map(function(i){return i.Price});
                  var sl_minrange = Math.min(...price);
                  var sl_maxrange = Math.max(...price);

                  if (price.length > 0){
                    // Diplay results table header when data exists
                    $(".disptable").show();
                    // calculate start and end vlaues for slider range
                    var sl_stvalue = sl_minrange + 1;
                    console.log('sm',sl_minrange,sl_stvalue)
                    var sl_endvalue = sl_maxrange - 5;
                    console.log('sm2',sl_maxrange,sl_endvalue)

                    x= document.getElementById('id_myslider')
                    x.noUiSlider.updateOptions({
                        start :[sl_stvalue,sl_endvalue],
                        range: {
                                min: sl_minrange,
                                max: sl_maxrange
                              }
                      }, true);

                    } else {
                      //Display No data found
                      $(".nodata").show();
              }
              m.redraw();  {# Refresh all Mithril content #}
          });
        }) // getCurrentPosition
      } //searchdata

    // m.mount is used to activate mithril component(fuleappdata) and enable autodraw
    m.mount(document.getElementById('fueldata'), fuleappdata);



  </script>
  {% endblock %}
